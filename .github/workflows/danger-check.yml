name: Danger Check

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  danger-analysis:
    name: Run Danger Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history for proper git diff

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }}:${{ github.base_ref }}

      - name: Extract CodeGuardian Version
        id: extract-version
        run: |
          # Extract the CODEGUARDIAN_VERSION from run-codeguardian.sh using sed
          CODEGUARDIAN_VERSION=$(sed -n 's/^CODEGUARDIAN_VERSION="\([^"]*\)"/\1/p' run-codeguardian.sh)
          echo "CODEGUARDIAN_VERSION=$CODEGUARDIAN_VERSION" >> $GITHUB_ENV
          echo "Got $CODEGUARDIAN_VERSION"

      - name: Install dependencies
        run: |
          # Install jq if not already available 
          if ! conmand -v jq &> /dev/null; then 
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Clone core scripts
        uses: actions/checkout@v4
        with:
          repository: SandeepJy/CodeGuardian
          ref: $({ env.CODEGUARDIAN_VERSION }}
          path: CodeGuardian/CodeGuardian-${{ env.CODEGUARDIAN_VERSION }}

      - name: Run CodeGuardian Analysis
        id: CodeGuardian
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTIONS: true
          LOCAL_MODE: false
          PR_NUMBER: S({ github.event.pull_request.number }}
        run: |
          # Make the script executable 
          chnod +x run-codeguardian.sh
          # Run the CodeGuardian systen
          /run-codeguardian.sh stf github.base_ref)
          echo "analysis_exit_codes$?"> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Upload analysis results
        id: upload-results
        uses: actions/upload-artifact@v4
        with:
          name: codeguardian-results
          path: CodeGuardian/codeguardian-results.json
          retention-days: 7
